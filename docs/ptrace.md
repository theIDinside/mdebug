# Ptrace - The dark arts

Four kinds of "ptrace-stops"
- [Signal-delivery stops](#signal-delivery-stops)
- [Group-stops](#group-stops)
- [PTRACE_EVENT stops](#ptrace_event-stops)
- [Syscall-stops](#syscall-stops)

Things to know about ptrace
- ["Restarting requests"](#restarting-requests)
- [Passing signals on to the tracee](#passing-signals-to-the-tracee)

## Undocumented, unexpected behaviors encountered
When a thread hits a breakpoint, we want to interrupt all other threads (in all-stop mode). One thing we seemingly can't do, is using `PTRACE_INTERRUPT`. While only having tested it in a `PTRACE_SEIZE` session, interrupt will send a `SIGTRAP` signal which for some reason, will make the next request to `PTRACE_SINGLESTEP`, "return" immediately (with a `SIGTRAP` as a signal) without actually having singlestepped. So the next `waitpid` will return a `SIGTRAP` having been seen but no step.

Therefore, going forward, we are going to avoid _anything_ that sends a `SIGTRAP` to the tracee during a ptrace-stop, or during the time the tracee is executing but we as the tracer _expect_ to cause a ptrace-stop soon.

## Signal-delivery-stops
When a process receives a signal, the kernel designates an arbitrary thread as the handler. If the signal was generated by [tgkill](https://man7.org/linux/man-pages/man2/tgkill.2.html) the kernel will explicitly designate the desired thread as the handler.

If the thread is "traced" (via, for instance a `PTRACE_ATTACH`, or the thread being a child of an `PTRACE_ATTACH`ed or `PTRACE_SEIZE`d process), it will enter a `signal-delivery-stop`. The thread is now stopped, and a host of ptrace requests can be performed. The signal will *not* be delivered to the process, unless the tracer explicitly does so. To "pass the signal on" to the tracee, the tracer must pass this signal number in the next [`restarting`](#restarting-requests) ptrace request, like for instance `PTRACE_CONTINUE`. The signal number is, like most ptrace calls, passed as the `data` argument (the 4th).

## Group-stops
## PTRACE_EVENT-stops
## Syscall-stops


## Restarting requests

## Passing signals to the tracee
When we've `wait`ed on a process and we've found it to be in a [`signal-delivery-stop`](#signal-delivery-stops), if we want to pass the signal on to the tracee (maybe the tracee generated the signal itself, and we shouldn't interfere with it), we make a [restarting request](#restarting-requests) with the signal number passed as the 4th argument, e.g. `ptrace(PTRACE_CONT, pid, 0, signal_number)`.